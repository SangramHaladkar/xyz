package com.mobifilia.monitormymortgage.Activity;

import android.Manifest;
import android.app.Activity;
import android.app.DatePickerDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.content.pm.ActivityInfo;
import android.content.pm.PackageManager;
import android.content.res.AssetFileDescriptor;
import android.database.Cursor;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.graphics.Matrix;
import android.graphics.Typeface;
import android.media.ExifInterface;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.os.Environment;
import android.preference.PreferenceManager;
import android.provider.MediaStore;
import android.support.annotation.NonNull;
import android.support.v4.app.ActivityCompat;
import android.support.v4.content.ContextCompat;
import android.support.v7.app.AlertDialog;
import android.support.v7.widget.RecyclerView;
import android.support.v7.widget.Toolbar;
import android.text.InputFilter;
import android.text.InputType;
import android.util.Base64;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.Menu;
import android.view.View;
import android.view.inputmethod.InputMethodManager;
import android.webkit.MimeTypeMap;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.DatePicker;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.ListView;
import android.widget.RadioButton;
import android.widget.RadioGroup;
import android.widget.RelativeLayout;
import android.widget.TextView;
import android.widget.Toast;

import com.eris.androidddp.ErisCollectionManager;
import com.ipaulpro.afilechooser.utils.FileUtils;
import com.kaopiz.kprogresshud.KProgressHUD;
import com.mobifilia.monitormymortgage.Adapters.ArrayAdapterItem;
import com.mobifilia.monitormymortgage.Adapters.PreviewAdapter;
import com.mobifilia.monitormymortgage.BaseClasses.BaseActivity;
import com.mobifilia.monitormymortgage.BaseClasses.ShowLenderListPopup;
import com.mobifilia.monitormymortgage.BaseClasses.ToastMessage;
import com.mobifilia.monitormymortgage.BaseClasses.ViewDialog;
import com.mobifilia.monitormymortgage.Common.CommonConstants;
import com.mobifilia.monitormymortgage.Common.CustomTextWatcherInterestRate;
import com.mobifilia.monitormymortgage.Common.EditTextThousand;
import com.mobifilia.monitormymortgage.Common.InputFilterMinMax;
import com.mobifilia.monitormymortgage.DataHolderClasses.AttachmentFileData;
import com.mobifilia.monitormymortgage.DataHolderClasses.MortgageDetailsEdit;
import com.mobifilia.monitormymortgage.DataHolderClasses.ObjectItem;
import com.mobifilia.monitormymortgage.Fragments.PrimaryResidenceFragment;
import com.mobifilia.monitormymortgage.R;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;

import im.delight.android.ddp.ResultListener;


public class EditMortgageActivity extends BaseActivity implements View.OnClickListener {
    private static final String TAG = EditMortgageActivity.class.getSimpleName();
    final private int REQUEST_CODE_ASK_PERMISSIONS = 456;
    private TextView currencySpineerTextView;
    private TextView paymentFrequencyTwoTextview;
    private TextView actualMaturityDateEditText;
    private TextView actualStartDateEditText;
    private TextView stepOneTextView;
    private TextView stepTwoTextView;
    private TextView stepThreeTextView;
    private LinearLayout stepOneLinearLayout;
    private LinearLayout stepTwoLinearLayout;
    private LinearLayout stepThreeLinearLayout;
    private TextView paymentFrequencySpinnerTextview;
    private TextView actualRateIncreaseTextView;
    private TextView actualNotifyMeTextView;
    private TextView actaulCurrencyTextview;
    private Button step_one_btn_next;
    private Button step_two_btn_next;
    private Button step_two_btn_previous;
    private Button step_three_btn_previous;
    CharSequence[] rateIncreaseItems;
    CharSequence[] noifyMeItems;
    CharSequence[] currencyItems;
    CharSequence[] paymentFrequencyItems;
    CharSequence[] MortgageTypeItems;
    CharSequence[] MortgageStatus;
    CharSequence[] CurrentTerm;
    Calendar myCalendar;
    ToastMessage toastMessage;
    EditText actualTitleEditText;
    EditText postalCodeEditText;
    EditText totalMortgageEditText;
    EditText currentAmortizedMortgageValueEditText;
    private DatePickerDialog fromDatePickerDialog;
    private DatePickerDialog toDatePickerDialog;
    private SimpleDateFormat dateFormatter;
    EditText AmortizationTermEditText;
    EditText currentPaymentAmtEditText;
    EditText actualInterestRateEditText;
    EditText discountRateEditText;
    EditText currentPaymentEditText;
    EditText creditLineAmtEditText;
    EditText savingAmtPerMonthEditText;
    EditText actualremainingTermEditText;
    EditText actualMpacEditText;
    Button btn_save_monitor;
    public ImageView lenderLogoImageview;
    RadioGroup toggle;
    List<Bitmap> lenderString;
    ShowLenderListPopup showLenderListPopup;
    TextView selectLenderTextview;
    String lenderId;
    ArrayList<ObjectItem> objectItemArrayList;
    String lenderName;
    String mortgageType;
    TextView takePictureTextView;
    Typeface typeface;
    TextView currentTermNumberTextView, mortgageTypeTextView, mortgageStatusTextView;
    String termsInMonth;

    int termInYear;
    String notifyMe;
    String rateIncrease;
    String mortgageID;
    int arivalYear, arivalMonth, arivalDay;
    MortgageDetailsEdit mortgageDetailsEdit;
    String lenderLogoString;
    TextView otherLenderErrorTextView;
    EditText lenderEditText;
    String otherLenderName;
    long startTime;
    long maturityTime;
    String startDateNotUpdated;
    String maturityDateNotUpdated;
    Date nextYear;
    String lenderNamePopup;
    String facebookUserLoginId;
    boolean facebookUserLoginFlag;
    String googleUserLoginId;
    boolean googleUserLoginFlag;
    String username;
    ImageView btnCamera;
    private Uri fileUri;
    final int CAPTURE_IMAGE_ACTIVITY_REQUEST_CODE = 2989;
    private static final int REQUEST_CODE = 6384;
    private PreviewAdapter fileAdapter;
    private ArrayList<AttachmentFileData> fileDataList;
    int thumbFactor = 4;
    RecyclerView img_recycler_view;
    boolean is_attachment_updated;
    boolean is_document_deleted;
    boolean is_document_added;
    public static boolean flag = false;
    public static final String ATTACHMENTLISTKEY = "attachmentsList";
    private static final int PHOTO_PREVIEW_REQUEST_CODE = 6384;
    RelativeLayout selectCurrencyRelativeLayout;
    RelativeLayout selectLenderRelativeLayout;
    RelativeLayout rateIncreaseRelativeLayout;
    RelativeLayout notifyMeRelativeLayout;
    RelativeLayout selectFrequencyRelativeLayout;
    ArrayList<String> arrayList;

    @Override
    public void onBackPressed() {
        new ViewDialog(this).showPopupAddMortgage(EditMortgageActivity.this, R.string.mortgage_incomplete_msg, R.string.mortgage_incomplete_title);

    }

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_add_mortgage);
        this.setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);
        Toolbar toolbar = (Toolbar) findViewById(R.id.toolbar);
        setSupportActionBar(toolbar);
        toolbar.hideOverflowMenu();
        arrayList = new ArrayList<>();
        selectCurrencyRelativeLayout = (RelativeLayout) findViewById(R.id.selectCurrencyRelativeLayout);
        selectLenderRelativeLayout = (RelativeLayout) findViewById(R.id.selectLenderRelativeLayout);
        rateIncreaseRelativeLayout = (RelativeLayout) findViewById(R.id.rateIncreaseRelativeLayout);
        notifyMeRelativeLayout = (RelativeLayout) findViewById(R.id.notifyMeRelativeLayout);
        selectFrequencyRelativeLayout = (RelativeLayout) findViewById(R.id.selectFrequencyRelativeLayout);
        is_attachment_updated = false;
        is_document_deleted = false;
        is_document_added = false;
        facebookUserLoginId = PreferenceManager.getDefaultSharedPreferences(this).getString("FacebookUserLoginId", "");
        facebookUserLoginFlag = PreferenceManager.getDefaultSharedPreferences(this).getBoolean("FacebookUserLoginFlag", false);
        googleUserLoginId = PreferenceManager.getDefaultSharedPreferences(this).getString("GoogleUserLoginId", "");
        googleUserLoginFlag = PreferenceManager.getDefaultSharedPreferences(this).getBoolean("GoogleUserLoginFlag", false);
        username = PreferenceManager.getDefaultSharedPreferences(this).getString("username", "");
        if (CommonConstants.mDebug) Log.v(TAG, username);
        mortgageID = getIntent().getExtras().getString("MortgageID");
        lenderLogoString = getIntent().getExtras().getString("lenderLogo");
        lenderId = getIntent().getExtras().getString("lenderid");
        termInYear = getIntent().getExtras().getInt("term");
        Log.v(TAG, "Term 2 " + termInYear);
        if (CommonConstants.mDebug) {
            Log.v(TAG, mortgageID);
        }
        if (CommonConstants.mDebug) {
            Log.v(TAG, lenderId);
        }
        getMortgageDetails(mortgageID);
        fileDataList = new ArrayList<>();
        fileAdapter = new PreviewAdapter(this, fileDataList);
        ViewDialog.showProgress(R.string.help_screen_one, EditMortgageActivity.this, R.string.progress_wait_while_loading);
        showLenderListPopup = new ShowLenderListPopup();
        objectItemArrayList = new ArrayList<>();
        toolbar.setNavigationIcon(ContextCompat.getDrawable(this, R.drawable.previous));
        toolbar.setNavigationOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                new ViewDialog(EditMortgageActivity.this).showPopupAddMortgage(EditMortgageActivity.this, R.string.mortgage_incomplete_msg, R.string.mortgage_incomplete_title);
            }
        });
        myCalendar = Calendar.getInstance();
        typeface = Typeface.createFromAsset(getAssets(), "fontawesome-webfont.ttf");
        toastMessage = new ToastMessage(this);
        dateFormatter = new SimpleDateFormat("MMM d,yyyy", Locale.US);
        initialiseUIComponent();
        if (lenderLogoString.length() > 10) {
            selectLenderTextview.setVisibility(View.GONE);
            lenderLogoImageview.setImageBitmap(new PrimaryResidenceFragment().base64(lenderLogoImageview, lenderLogoString));
        } else {
            selectLenderTextview.setVisibility(View.VISIBLE);
            selectLenderTextview.setText("Other");
            lenderLogoImageview.setVisibility(View.GONE);
        }
        mortgageDetailsEdit = new MortgageDetailsEdit();
        stepOneLinearLayout.setVisibility(View.VISIBLE);
        stepTwoLinearLayout.setVisibility(View.GONE);
        stepThreeLinearLayout.setVisibility(View.GONE);

        stepOneTextView.setBackgroundResource(R.drawable.steponesel);
        stepTwoTextView.setBackgroundResource(R.drawable.steptwounselectedstepthreeunselected);
        stepThreeTextView.setBackgroundResource(R.drawable.stepthreeunselected);

        //      Step One UI Handling                     //
        stepOneTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                stepOneDetails();
            }
        });
        step_one_btn_next.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (CommonConstants.mDebug) {
                    Log.v(TAG, "On next button click");
                }
                if (validationStepOne()) {
                    stepTwoDetails();
                }
            }
        });

        //      Step One UI Handling                     //
        stepOneTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                stepOneDetails();
            }
        });
        step_one_btn_next.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (CommonConstants.mDebug) {
                    Log.v(TAG, "On next button click");
                }
                if (validationStepOne()) {
                    stepTwoDetails();
                    hideKeyboard(v);
                }
            }
        });
        stepThreeTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (validationStepOne()) {
                    stepThreeDetails();
                }
            }
        });

        //      Step Two UI Handling      //
        stepTwoTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (stepOneLinearLayout.isShown() && validationStepOne()) {
                    stepTwoDetails();
                    hideKeyboard(v);
                }
                if (stepThreeLinearLayout.isShown()) {
                    stepTwoDetails();
                    hideKeyboard(v);
                }
            }
        });
        step_two_btn_previous.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                stepOneDetails();
            }
        });
        step_two_btn_next.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (validationStepTwo()) {
                    stepThreeDetails();
                    hideKeyboard(v);

                }
            }
        });

        stepOneTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                stepOneDetails();
            }
        });
        stepThreeTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (validationStepTwo()) {
                    stepThreeDetails();
                    hideKeyboard(v);
                }
            }
        });
        //      Step Three UI Handling                     //
        stepThreeTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (validationStepOne() && validationStepTwo()) {
                    stepThreeDetails();
                    hideKeyboard(v);
                }
            }
        });
        step_three_btn_previous.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {

                stepTwoDetails();
            }
        });
        btn_save_monitor.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (valiadationStepThree()) {
                    ViewDialog.showProgress(R.string.help_screen_one, EditMortgageActivity.this, R.string.progress_save_mortgage);
                    updateMortgage(EditMortgageActivity.this);
                }
            }
        });
        rateIncreaseSpinnerSelect();
        notifyMeSpinnerSelect();
        currencySpineerTextViewSelect();
        paymentFrequencySpinnerTextviewSelect();
        setDateTimeField();
        showLenderList();
        getLenderList();
        getMortgageTypeRadioButtonClick();
        currentTermDropdownClick();
        mortgageTypeDropdownClick();
        mortgageStatusDropdownClick();
        cameraBtnClick();
        selectPostalCode();
        getAllMasters();
        totalMortgageEditText.addTextChangedListener(new EditTextThousand(totalMortgageEditText));
        currentAmortizedMortgageValueEditText.addTextChangedListener(new EditTextThousand(currentAmortizedMortgageValueEditText));
        currentPaymentAmtEditText.addTextChangedListener(new EditTextThousand(currentPaymentAmtEditText));
        actualInterestRateEditText.addTextChangedListener(new CustomTextWatcherInterestRate(actualInterestRateEditText));
        discountRateEditText.addTextChangedListener(new CustomTextWatcherInterestRate(discountRateEditText));
        creditLineAmtEditText.addTextChangedListener(new EditTextThousand(creditLineAmtEditText));
        savingAmtPerMonthEditText.addTextChangedListener(new EditTextThousand(savingAmtPerMonthEditText));
        actualremainingTermEditText.addTextChangedListener(new EditTextThousand(actualremainingTermEditText));
    }

    public void hideKeyboard(View view) {
        //  Hide Keyboard.
        InputMethodManager imm = (InputMethodManager) getSystemService(Context.INPUT_METHOD_SERVICE);
        imm.hideSoftInputFromWindow(view.getWindowToken(), 0);
    }

    public void selectPostalCode() {
        postalCodeEditText.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent intent = new Intent(EditMortgageActivity.this, PostalCodeActivity.class);
                startActivityForResult(intent, 1);
            }
        });
    }

    public void getMortgageTypeRadioButtonClick() {
        mortgageType = ((RadioButton) findViewById(toggle.getCheckedRadioButtonId())).getText().toString();
        if (CommonConstants.mDebug) {
            Log.v(TAG, mortgageType);
        }
        toggle.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(RadioGroup group, int checkedId) {
                switch (checkedId) {
                    case R.id.residential:
                        mortgageType = "Residential";
                        if (CommonConstants.mDebug) {
                            Log.v(TAG, mortgageType);
                        }
                        break;
                    case R.id.commercial:
                        mortgageType = "Commercial";
                        if (CommonConstants.mDebug) {
                            Log.v(TAG, mortgageType);
                        }
                        break;
                }
            }
        });
    }

    public void getAllMasters() {
        HashMap<String, Object> stringObjectHashMap = new HashMap<>();
        stringObjectHashMap.put("lang", "en");
        stringObjectHashMap.put("req_from", "android");
        ErisCollectionManager.getInstance().callMethod("getAllMasters", new Object[]{stringObjectHashMap}, new ResultListener() {
            @Override
            public void onSuccess(String result) {
                if (CommonConstants.mDebug) Log.v("TAG", result);
                try {
                    JSONObject jsonObjectMain = new JSONObject(result);
                    JSONObject jsonObjectData = jsonObjectMain.getJSONObject("data");
                    JSONObject jsonObjectResult = jsonObjectData.getJSONObject("result");
                    JSONArray jsonArrayPaymentFrequencyMaster = jsonObjectResult.getJSONArray("mortgage_payment_frequency");
                    JSONArray jsonArrayRateIncreaseMaster = jsonObjectResult.getJSONArray("user_notify_rate_increase_bps");
                    JSONArray jsonArrayCurrencyMaster = jsonObjectResult.getJSONArray("mortgage_currency");
                    JSONArray jsonArrayMaturityDaysMaster = jsonObjectResult.getJSONArray("user_notify_until_maturity_days");
                    JSONArray jsonArrayCurrentTermType = jsonObjectResult.getJSONArray("mortgage_current_term_type");
                    JSONArray jsonArrayCurrentTermRateType = jsonObjectResult.getJSONArray("mortgage_current_term_rate_type");
                    JSONArray jsonArrayCurrentTerm = jsonObjectResult.getJSONArray("mortgage_current_term");
                    /* Get Payment Frequency Master*/
                    for (int i = 0; i < jsonArrayPaymentFrequencyMaster.length(); i++) {
                        JSONObject jsonObject1 = jsonArrayPaymentFrequencyMaster.getJSONObject(i);
                        arrayList.add(jsonObject1.getString("key"));
                        paymentFrequencyItems = arrayList.toArray(new CharSequence[arrayList.size()]);
                    }
                    arrayList.clear();

                    /* Get Rate Increase Master*/
                    for (int i = 0; i < jsonArrayRateIncreaseMaster.length(); i++) {
                        JSONObject jsonObject1 = jsonArrayRateIncreaseMaster.getJSONObject(i);
                        arrayList.add(jsonObject1.getString("val"));
                        rateIncreaseItems = arrayList.toArray(new CharSequence[arrayList.size()]);
                    }

                    arrayList.clear();

                    /*Get Mortgage currency Masters*/
                    for (int i = 0; i < jsonArrayCurrencyMaster.length(); i++) {
                        JSONObject jsonObject1 = jsonArrayCurrencyMaster.getJSONObject(i);
                        arrayList.add(jsonObject1.getString("val"));
                        currencyItems = arrayList.toArray(new CharSequence[arrayList.size()]);

                    }

                    arrayList.clear();
                    /* Get Current Term Type Masters*/
                    for (int i = 0; i < jsonArrayCurrentTermType.length(); i++) {
                        JSONObject jsonObject1 = jsonArrayCurrentTermType.getJSONObject(i);
                        arrayList.add(jsonObject1.getString("val"));
                        MortgageTypeItems = arrayList.toArray(new CharSequence[arrayList.size()]);

                    }
                    arrayList.clear();
                    /* Get Current Term Rate Type*/
                    for (int i = 0; i < jsonArrayCurrentTermRateType.length(); i++) {
                        JSONObject jsonObject1 = jsonArrayCurrentTermRateType.getJSONObject(i);
                        arrayList.add(jsonObject1.getString("val"));
                        MortgageStatus = arrayList.toArray(new CharSequence[arrayList.size()]);

                    }
                    arrayList.clear();
                    /* Get Notify Until Maturity Days Masters*/
                    for (int i = 0; i < jsonArrayMaturityDaysMaster.length(); i++) {
                        JSONObject jsonObject1 = jsonArrayMaturityDaysMaster.getJSONObject(i);
                        arrayList.add(jsonObject1.getString("val"));
                        noifyMeItems = arrayList.toArray(new CharSequence[arrayList.size()]);

                    }
                    arrayList.clear();
                                        /* Get Term in Year Masters*/
                    for (int i = 0; i < jsonArrayCurrentTerm.length(); i++) {
                        JSONObject jsonObject1 = jsonArrayCurrentTerm.getJSONObject(i);
                        arrayList.add(jsonObject1.getString("val"));
                        CurrentTerm = arrayList.toArray(new CharSequence[arrayList.size()]);
                    }
                    arrayList.clear();


                } catch (JSONException e) {
                    e.printStackTrace();
                }


            }

            @Override
            public void onError(String error, String reason, String details) {

            }
        });
    }

    public void cameraBtnClick() {
        btnCamera.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (CommonConstants.mDebug) Log.v(TAG, "Select Photo");
                is_attachment_updated = true;
                is_document_added = true;
                int hasWriteExternalStorage = ActivityCompat.checkSelfPermission(EditMortgageActivity.this, Manifest.permission.WRITE_EXTERNAL_STORAGE);
                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M && hasWriteExternalStorage != PackageManager.PERMISSION_GRANTED) {
                    requestPermissions(new String[]{Manifest.permission.WRITE_EXTERNAL_STORAGE},
                            REQUEST_CODE_ASK_PERMISSIONS);
                } else if (hasWriteExternalStorage == PackageManager.PERMISSION_GRANTED) {
                    openImageFileChooser("Upload Image", "image");
                }

            }
        });
    }

    public void openImageFileChooser(String msg, String fileType) {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd_HHmmss");
        String fileName = "IMG_" + sdf.format(new Date()) + ".jpg";
        File myDirectory = new File(Environment.getExternalStorageDirectory() + "/M3/");
        if (!myDirectory.exists())
            myDirectory.mkdirs();
        File file = new File(myDirectory, fileName);
        fileUri = Uri.fromFile(file);

        Intent imageIntent = new Intent(android.provider.MediaStore.ACTION_IMAGE_CAPTURE);
        imageIntent.putExtra(MediaStore.EXTRA_OUTPUT, fileUri);

        Intent pickIntent = new Intent(Intent.ACTION_PICK, android.provider.MediaStore.Images.Media.EXTERNAL_CONTENT_URI);
        pickIntent.setType(fileType + "/*");

        Intent chooserIntent = Intent.createChooser(pickIntent, msg);
        chooserIntent.putExtra(Intent.EXTRA_INITIAL_INTENTS, new Intent[]{imageIntent});

        try {
            startActivityForResult(chooserIntent, CAPTURE_IMAGE_ACTIVITY_REQUEST_CODE);
        } catch (Exception e) {
            // The reason for the existence of aFileChooser
            e.printStackTrace();
        }

    }

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
        super.onActivityResult(requestCode, resultCode, data);
        if (resultCode == RESULT_OK) {
            if (requestCode == CAPTURE_IMAGE_ACTIVITY_REQUEST_CODE) {
                try {
                    Uri imageUri = fileUri;
                    Bitmap scaledOriginalImage;
                    if (imageUri != null && (data == null || data.getData() == null)) {
                        BitmapFactory.Options options = new BitmapFactory.Options();
                        options.inSampleSize = 4;

                        AssetFileDescriptor fileDescriptor;

                        fileDescriptor = this.getContentResolver().openAssetFileDescriptor(imageUri, "r");

                        Bitmap bitmap = BitmapFactory.decodeFileDescriptor(fileDescriptor.getFileDescriptor(), null, options);
                        int bitmapWidth = bitmap.getWidth();
                        if (CommonConstants.mDebug) Log.v(TAG, "bitmap width" + bitmapWidth);
                        if (bitmapWidth > 1024) {
                            //create scaled image from original image.Resize width to 1024.
                            scaledOriginalImage = Bitmap.createScaledBitmap(bitmap, 1024, bitmap.getHeight(), false);
                        } else {
                            scaledOriginalImage = Bitmap.createScaledBitmap(bitmap, bitmap.getWidth(), bitmap.getHeight(), false);
                        }
                        // create thumbnail of image/bitmap captured from camera.
                        Bitmap thumb = Bitmap.createScaledBitmap(scaledOriginalImage, 100, 100, false);
                        if (CommonConstants.mDebug) Log.v(TAG, "thumbWidth" + thumb.getWidth());
                        if (CommonConstants.mDebug) Log.v(TAG, "thumbHeight" + thumb.getHeight());
                        Bitmap rotatedImage = roatedBitmap(fileUri.getPath(), scaledOriginalImage);
                        final String path = FileUtils.getPath(this, imageUri);
                        String fileName = getFileNameByUri(this, imageUri);
                        File file = new File(path);
                        double fileLength = file.length();
                        double fileSizeKb = (fileLength / 1024);
                        double fileSizeMb = (fileSizeKb / 1024);

                        ByteArrayOutputStream stream = new ByteArrayOutputStream();
                        scaledOriginalImage.compress(Bitmap.CompressFormat.JPEG, 50, stream);
                        byte[] bitmapData = stream.toByteArray();


                        ByteArrayOutputStream stream1 = new ByteArrayOutputStream();
                        thumb.compress(Bitmap.CompressFormat.JPEG, 50, stream1);
                        byte[] thumbData = stream1.toByteArray();

                        if (fileSizeMb <= 5) {
                            AttachmentFileData attachmentFileData = new AttachmentFileData();
                            attachmentFileData.setFileName(fileName);
                            attachmentFileData.setFileSize("" + Math.round(fileSizeKb));
                            attachmentFileData.setFileBase64String(Base64.encodeToString(bitmapData, Base64.DEFAULT));
                            attachmentFileData.setFileType(getMimeType(fileName));
                            attachmentFileData.setThumbNailBase64String(Base64.encodeToString(thumbData, Base64.DEFAULT));
//                                attachmentFileData.setImageBitMap(bitmap);
                            fileDataList.add(attachmentFileData);
                            setupRecyclerView(img_recycler_view, fileDataList);

                        } else {
                            ViewDialog.showAlertPopUp(EditMortgageActivity.this, "You can upload files upto 5 MB.", "Error");
//                            Toast.makeText(this, "Unable to attach", Toast.LENGTH_LONG).show();
                        }

                    } else if (data != null && data.getData() != null) {
                        // Get the URI of the selected file
                        final Uri uri = data.getData();
                        if (CommonConstants.mDebug)
                            Log.i("MainActivityResult", "Uri = " + uri.toString());
                        try {
                            // Get the file path from the URI
                            final String path = FileUtils.getPath(this, uri);
                            Bitmap rotatedImage;
                            Bitmap scaledOriginalImageLarge;
                            File file = new File(path);
                            String fileName = file.getName().replaceAll("\\s", "%20");
                            double fileLength = file.length();
                            double fileSizeKb = (fileLength / 1024);
                            double fileSizeMb = (fileSizeKb / 1024);
                            Bitmap bitmap = (BitmapFactory.decodeFile(path));
                            if (CommonConstants.mDebug)
                                Log.v(TAG, "bitmap width" + bitmap.getWidth());
                            if (bitmap.getWidth() > 1024) {
                                scaledOriginalImageLarge = Bitmap.createScaledBitmap(bitmap, 1024, bitmap.getHeight() / 3, false);
                                rotatedImage = roatedBitmap(path, scaledOriginalImageLarge);
                                Log.v(TAG, "rotatedImageWidth" + rotatedImage.getWidth());
                                Log.v(TAG, "rotatedImageHeight" + rotatedImage.getHeight());
                            } else {
                                scaledOriginalImageLarge = Bitmap.createScaledBitmap(bitmap, bitmap.getWidth(), bitmap.getHeight(), false);
                                rotatedImage = roatedBitmap(path, scaledOriginalImageLarge);
                                Log.v(TAG, "rotatedImageWidth" + rotatedImage.getWidth());
                                Log.v(TAG, "rotatedImageHeight" + rotatedImage.getHeight());

                            }
                            Bitmap thumb = Bitmap.createScaledBitmap(scaledOriginalImageLarge, 100, 100, false);

                            ByteArrayOutputStream stream1 = new ByteArrayOutputStream();
                            thumb.compress(Bitmap.CompressFormat.JPEG, 50, stream1);
                            byte[] thumbData = stream1.toByteArray();

                            ByteArrayOutputStream stream = new ByteArrayOutputStream();
                            if (getMimeType(fileName).contains("png") || getMimeType(fileName).contains("jpg") || getMimeType(fileName).contains("jpeg")) {
                                if (getMimeType(fileName).contains("png")) {
                                    rotatedImage.compress(Bitmap.CompressFormat.PNG, 50, stream);
                                } else {
                                    rotatedImage.compress(Bitmap.CompressFormat.JPEG, 50, stream);
                                }
                                byte[] bitmapData2 = stream.toByteArray();

                                if (fileSizeMb <= 5) {
                                    AttachmentFileData attachmentFileData = new AttachmentFileData();
                                    attachmentFileData.setFileName(fileName);
                                    attachmentFileData.setFileSize("" + Math.round(fileSizeKb));
                                    attachmentFileData.setFileBase64String(Base64.encodeToString(bitmapData2, Base64.DEFAULT));
                                    attachmentFileData.setThumbNailBase64String(Base64.encodeToString(thumbData, Base64.DEFAULT));
                                    attachmentFileData.setFileType(getMimeType(fileName));
//                                        attachmentFileData.setImageBitMap(bitmap);
                                    fileDataList.add(attachmentFileData);
                                    setupRecyclerView(img_recycler_view, fileDataList);
                                } else {
                                    ViewDialog.showAlertPopUp(EditMortgageActivity.this, "You can upload files upto 5 MB.", "Error");
                                }
                            } else {
                                ViewDialog.showAlertPopUp(EditMortgageActivity.this, "Supported file types: .jpg, .png, .pdf, .gif.", "Error");
                            }
                        } catch (Exception e) {
                            if (CommonConstants.mDebug)
                                Log.e("MainActivityResult", "File select error" + e.getMessage());
                        }
                    } else {
//                            attachImgFile.setImageDrawable(this.getResources().getDrawable(R.drawable.avatar));
                    }
                } catch (FileNotFoundException e) {
                    e.printStackTrace();
                }

            } else if (requestCode == PHOTO_PREVIEW_REQUEST_CODE) {
                if (data != null) {
                    Bundle bdata = data.getExtras();
                    is_attachment_updated = bdata.getBoolean("isDocumentDeleted");
                    fileDataList = (ArrayList<AttachmentFileData>) bdata.getSerializable(ATTACHMENTLISTKEY);
                    setupRecyclerView(img_recycler_view, fileDataList);

                }
            } else if (requestCode == 1) {
                if (resultCode == RESULT_OK) {
                    String postalCode = data.getStringExtra("postal_code");
                    postalCodeEditText.setText(postalCode);
                }
            }
        }

    }


    //setup recycler view

    private void setupRecyclerView(@NonNull final RecyclerView recyclerView, ArrayList<AttachmentFileData> fileDataArrayList) {
        recyclerView.setVisibility(View.VISIBLE);
        fileAdapter = new PreviewAdapter(this, fileDataList);
        recyclerView.setAdapter(fileAdapter);
        fileAdapter.setCallBack(new PreviewAdapter.RecyclerViewListeners() {
            @Override
            public void onRecycleItemClick(ArrayList<AttachmentFileData> filesDataList, int position) {
//                       Toast.makeText(AddMortgageActivity.this,filesDataList.get(position).getFileName(),Toast.LENGTH_LONG).show();
                Intent previewIntent = new Intent(EditMortgageActivity.this, PhotoPreviewActivity.class);
                Bundle bundle = new Bundle();
                bundle.putInt("position", position);
                bundle.putSerializable(ATTACHMENTLISTKEY, filesDataList);
                previewIntent.putExtras(bundle);
                startActivityForResult(previewIntent, PHOTO_PREVIEW_REQUEST_CODE);
                flag = true;
            }

            @Override
            public void onCloseIconClick(ArrayList<AttachmentFileData> filesDataList, int position) {
                filesDataList.remove(position);
                is_attachment_updated = true;
                is_document_deleted = true;
                fileAdapter.notifyDataSetChanged();
                if (filesDataList.size() >= 5) {
                    btnCamera.setVisibility(View.GONE);
                    takePictureTextView.setVisibility(View.GONE);
                } else if (filesDataList.size() == 0) {
                    btnCamera.setVisibility(View.VISIBLE);
                    takePictureTextView.setVisibility(View.VISIBLE);
                    recyclerView.setVisibility(View.GONE);
                } else {
                    btnCamera.setVisibility(View.VISIBLE);
                    takePictureTextView.setVisibility(View.VISIBLE);
                }
            }
        });
        if (fileDataArrayList.size() >= 5) {
            btnCamera.setVisibility(View.GONE);
            takePictureTextView.setVisibility(View.GONE);
        } else if (fileDataArrayList.size() == 0) {
            btnCamera.setVisibility(View.VISIBLE);
            takePictureTextView.setVisibility(View.VISIBLE);
            recyclerView.setVisibility(View.GONE);
        } else {
            btnCamera.setVisibility(View.VISIBLE);
            takePictureTextView.setVisibility(View.VISIBLE);
        }
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        flag = false;
    }

    public void initialiseUIComponent() {
        selectLenderTextview = (TextView) findViewById(R.id.selectLenderTextview);
        stepOneTextView = (TextView) findViewById(R.id.stepOneTextView);
        stepTwoTextView = (TextView) findViewById(R.id.stepTwoTextView);
        stepThreeTextView = (TextView) findViewById(R.id.stepThreeTextView);
        stepOneLinearLayout = (LinearLayout) findViewById(R.id.stepOneLinearLayout);
        stepTwoLinearLayout = (LinearLayout) findViewById(R.id.stepTwoLinearLayout);
        stepThreeLinearLayout = (LinearLayout) findViewById(R.id.stepThreeLinearLayout);
        actualRateIncreaseTextView = (TextView) findViewById(R.id.actualRateIncreaseTextView);
        actualNotifyMeTextView = (TextView) findViewById(R.id.actualNotifyMeTextView);
        actaulCurrencyTextview = (TextView) findViewById(R.id.actaulCurrencyTextview);
        paymentFrequencyTwoTextview = (TextView) findViewById(R.id.paymentFrequencyTwoTextview);
        actualMaturityDateEditText = (TextView) findViewById(R.id.actualMaturityDateEditText);
        actualMaturityDateEditText.setInputType(InputType.TYPE_NULL);
        actualStartDateEditText = (TextView) findViewById(R.id.actualStartDateEditText);
        actualStartDateEditText.setInputType(InputType.TYPE_NULL);
        step_one_btn_next = (Button) findViewById(R.id.step_one_btn_next);
        step_two_btn_next = (Button) findViewById(R.id.step_two_btn_next);
        step_two_btn_previous = (Button) findViewById(R.id.step_two_btn_previous);
        step_three_btn_previous = (Button) findViewById(R.id.step_three_btn_previous);
        actualTitleEditText = (EditText) findViewById(R.id.actualTitleEditText);
        postalCodeEditText = (EditText) findViewById(R.id.postalCodeEditText);
        totalMortgageEditText = (EditText) findViewById(R.id.totalMortgageEditText);
        currentAmortizedMortgageValueEditText = (EditText) findViewById(R.id.currentAmortizedMortgageValueEditText);
        AmortizationTermEditText = (EditText) findViewById(R.id.AmortizationTermEditText);
        AmortizationTermEditText.setFilters(new InputFilter[]{new InputFilterMinMax("1", "360")});
        currentPaymentAmtEditText = (EditText) findViewById(R.id.currentPaymentAmtEditText);
        actualInterestRateEditText = (EditText) findViewById(R.id.actualInterestRateEditText);
        discountRateEditText = (EditText) findViewById(R.id.discountRateEditText);
        creditLineAmtEditText = (EditText) findViewById(R.id.creditLineAmtEditText);
        savingAmtPerMonthEditText = (EditText) findViewById(R.id.savingAmtPerMonthEditText);
        actualremainingTermEditText = (EditText) findViewById(R.id.actualremainingTermEditText);
        actualMpacEditText = (EditText) findViewById(R.id.actualMpacEditText);
        btn_save_monitor = (Button) findViewById(R.id.btn_save_monitor);
        lenderLogoImageview = (ImageView) findViewById(R.id.lenderLogoImageview);
        lenderLogoImageview.setVisibility(View.VISIBLE);
        selectLenderTextview = (TextView) findViewById(R.id.selectLenderTextview);
        toggle = (RadioGroup) findViewById(R.id.toggle);
        currentTermNumberTextView = (TextView) findViewById(R.id.currentTermNumberTextView);
        mortgageTypeTextView = (TextView) findViewById(R.id.mortgageTypeTextView);
        mortgageStatusTextView = (TextView) findViewById(R.id.mortgageStatusTextView);
        img_recycler_view = (RecyclerView) findViewById(R.id.img_recycler_view);
        btnCamera = (ImageView) findViewById(R.id.btnCamera);
        takePictureTextView = (TextView) findViewById(R.id.takePictureTextView);
    }

    public void currentTermDropdownClick() {
        currentTermNumberTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (!actualStartDateEditText.getText().toString().equals("Select Date")) {
                    actualStartDateEditText.setText("Select Date");
                    actualMaturityDateEditText.setText("Select Date");
                }
                AlertDialog.Builder builder = new AlertDialog.Builder(EditMortgageActivity.this);
                builder.setTitle("Select Term");
                builder.setItems(CurrentTerm, new DialogInterface.OnClickListener() {
                    public void onClick(DialogInterface dialog, int item) {
                        // Do something with the selection
                        if (CommonConstants.mDebug) {
                            Log.v(TAG, CurrentTerm[item].toString());
                        }
                        currentTermNumberTextView.setText(CurrentTerm[item].toString());
                        if (CurrentTerm[item].toString().equalsIgnoreCase("6 Mth")) {
                            termsInMonth = "6";
                        }
                        if (CurrentTerm[item].toString().equalsIgnoreCase("1 Yr")) {
                            termsInMonth = "12";
                            termInYear = 1;
                        }
                        if (CurrentTerm[item].toString().equalsIgnoreCase("2 Yr")) {
                            termsInMonth = "24";
                            termInYear = 2;
                        }
                        if (CurrentTerm[item].toString().equalsIgnoreCase("3 Yr")) {
                            termsInMonth = "36";
                            termInYear = 3;
                        }
                        if (CurrentTerm[item].toString().equalsIgnoreCase("4 Yr")) {
                            termsInMonth = "48";
                            termInYear = 4;
                        }
                        if (CurrentTerm[item].toString().equalsIgnoreCase("5 Yr")) {
                            termsInMonth = "60";
                            termInYear = 5;
                        }
                        if (CurrentTerm[item].toString().equalsIgnoreCase("6 Yr")) {
                            termsInMonth = "72";
                            termInYear = 6;
                        }
                        if (CurrentTerm[item].toString().equalsIgnoreCase("7 Yr")) {
                            termsInMonth = "84";
                            termInYear = 7;
                        }
                        if (CurrentTerm[item].toString().equalsIgnoreCase("8 Yr")) {
                            termsInMonth = "96";
                            termInYear = 8;
                        }
                        if (CurrentTerm[item].toString().equalsIgnoreCase("9 Yr")) {
                            termsInMonth = "108";
                            termInYear = 9;
                        }
                        if (CurrentTerm[item].toString().equalsIgnoreCase("10 Yr")) {
                            termsInMonth = "120";
                            termInYear = 10;
                        }
                    }
                });
                AlertDialog alert = builder.create();
                alert.show();

            }
        });
    }


    public void getMortgageDetails(String mortgageID) {

        HashMap<String, Object> stringObjectHashMap = new HashMap<>();
        stringObjectHashMap.put("mortgage_id", mortgageID);
        stringObjectHashMap.put("lang", "en");
        stringObjectHashMap.put("req_from", "android");

        ErisCollectionManager.getInstance().callMethod("getMortgageDetails", new Object[]{stringObjectHashMap}, new ResultListener() {
            @Override
            public void onSuccess(String result) {
                if (CommonConstants.mDebug) {
                    Log.v(TAG, result);
                }
                JSONObject jsonObjectResult = null;
                try {
                    jsonObjectResult = new JSONObject(result);
                    if (jsonObjectResult.getString("status").equalsIgnoreCase("true")) {
                        JSONObject jsonObjectData = jsonObjectResult.getJSONObject("data");
                        JSONObject jsonObjectResultMain = jsonObjectData.getJSONObject("result");
                        mortgageDetailsEdit.setTitle(jsonObjectResultMain.getString("title"));
                        if (jsonObjectResultMain.has("other_lender"))
                            mortgageDetailsEdit.setOtherLenderName(jsonObjectResultMain.getString("other_lender"));
                        mortgageDetailsEdit.setMortgagetypeRadioButton(jsonObjectResultMain.getString("type"));
                        mortgageDetailsEdit.setCurrency(jsonObjectResultMain.getString("currency"));
                        mortgageDetailsEdit.setPostalCode(jsonObjectResultMain.getString("property_postal_code"));
                        mortgageDetailsEdit.setMortgageOriginalValue(new BigDecimal(jsonObjectResultMain.getString("original_amount")).toPlainString());
                        if (jsonObjectResultMain.has("amortized_amount")) {
                            mortgageDetailsEdit.setAmortizedMortgageValue(new BigDecimal(jsonObjectResultMain.getString("amortized_amount")).toPlainString());
                        } else {
                            mortgageDetailsEdit.setAmortizedMortgageValue("");
                        }
                        mortgageDetailsEdit.setAmortizationTerm(jsonObjectResultMain.getString("amortization_term_in_months"));
                        mortgageDetailsEdit.setPaymentFrequency(jsonObjectResultMain.getString("current_payment_frequency"));
                        mortgageDetailsEdit.setPaymentAmt(new BigDecimal(jsonObjectResultMain.getString("current_payment_amount")).toPlainString());
                        mortgageDetailsEdit.setInterestRate(jsonObjectResultMain.getString("interest_rate_percentage"));

                        mortgageDetailsEdit.setRateDisc(jsonObjectResultMain.getString("discount_rate_percentage"));
                        mortgageDetailsEdit.setTerm(jsonObjectResultMain.getString("current_term_in_months"));
                        mortgageDetailsEdit.setStartDate(jsonObjectResultMain.getString("start_date_utc"));
                        startDateNotUpdated = jsonObjectResultMain.getString("start_date_utc");
                        maturityDateNotUpdated = jsonObjectResultMain.getString("maturity_date_utc");
                        mortgageDetailsEdit.setMaturityDate(jsonObjectResultMain.getString("maturity_date_utc"));
                        mortgageDetailsEdit.setStatus(jsonObjectResultMain.getString("current_term_type"));
                        mortgageDetailsEdit.setType(jsonObjectResultMain.getString("current_term_rate_type"));
                        if (jsonObjectResultMain.has("credit_line_amount")) {
                            mortgageDetailsEdit.setCreditLineAmt(new BigDecimal(jsonObjectResultMain.getString("credit_line_amount")).toPlainString());
                        } else {
                            mortgageDetailsEdit.setCreditLineAmt("");
                        }
                        mortgageDetailsEdit.setSavintAmtMonth(new BigDecimal(jsonObjectResultMain.getString("notify_saving_amount_per_month")).toPlainString());
                        mortgageDetailsEdit.setSavingAmtRemTerm(new BigDecimal(jsonObjectResultMain.getString("notify_saving_amount_over_remaining_term")).toPlainString());
                        mortgageDetailsEdit.setRateIncrease(jsonObjectResultMain.getString("notify_rate_increase_bps"));
                        mortgageDetailsEdit.setNotifyMe(jsonObjectResultMain.getString("notify_until_maturity_days"));
                        if (jsonObjectResultMain.has("mpac_number"))
                            mortgageDetailsEdit.setMpacNumber(jsonObjectResultMain.getString("mpac_number"));

                        JSONArray jsonArrayAttachment = jsonObjectResultMain.getJSONArray("attachments");
                        for (int i = 0; i < jsonArrayAttachment.length(); i++) {
                            AttachmentFileData attachmentFileData = new AttachmentFileData();
                            JSONObject jsonObjectCell = jsonArrayAttachment.getJSONObject(i);
                            attachmentFileData.setThumbNailBase64String(jsonObjectCell.getString("thumbnail_data"));
                            attachmentFileData.setDocId(jsonObjectCell.getString("doc_id"));
                            fileDataList.add(attachmentFileData);
                        }
                        setMortgageDetails();
                        setupRecyclerView(img_recycler_view, fileDataList);
//                        ViewDialog.hideProgress();
                    }
                } catch (JSONException e) {
                    e.printStackTrace();
                }
            }

            @Override
            public void onError(String error, String reason, String details) {
                if (CommonConstants.mDebug) Log.v(TAG, reason);
            }
        });
    }

    public void setMortgageDetails() {
        actualTitleEditText.setText(mortgageDetailsEdit.getTitle());
        lenderNamePopup = mortgageDetailsEdit.getOtherLenderName();
        actaulCurrencyTextview.setText(mortgageDetailsEdit.getCurrency());
        postalCodeEditText.setText(mortgageDetailsEdit.getPostalCode());

        if (!mortgageDetailsEdit.getMortgageOriginalValue().contains(".")) {
            totalMortgageEditText.setText(mortgageDetailsEdit.getMortgageOriginalValue() + ".00");
        } else {
            totalMortgageEditText.setText(mortgageDetailsEdit.getMortgageOriginalValue());
        }

        if (!mortgageDetailsEdit.getAmortizedMortgageValue().contains(".")) {
            currentAmortizedMortgageValueEditText.setText(mortgageDetailsEdit.getAmortizedMortgageValue() + ".00");
        } else {
            currentAmortizedMortgageValueEditText.setText(mortgageDetailsEdit.getAmortizedMortgageValue());
        }

        AmortizationTermEditText.setText(mortgageDetailsEdit.getAmortizationTerm());
        String toggle1 = mortgageDetailsEdit.getMortgagetypeRadioButton();
        if (toggle1.equalsIgnoreCase("Commercial")) {
            toggle.check(R.id.commercial);
        } else {
            toggle.check(R.id.residential);
        }

        paymentFrequencyTwoTextview.setText(mortgageDetailsEdit.getPaymentFrequency());
        if (!mortgageDetailsEdit.getPaymentAmt().contains(".")) {
            currentPaymentAmtEditText.setText(mortgageDetailsEdit.getPaymentAmt() + ".00");
        } else {
            currentPaymentAmtEditText.setText(mortgageDetailsEdit.getPaymentAmt());
        }
        if (!mortgageDetailsEdit.getInterestRate().contains(".")) {
            actualInterestRateEditText.setText(mortgageDetailsEdit.getInterestRate() + ".00");
        } else {
            actualInterestRateEditText.setText(mortgageDetailsEdit.getInterestRate());
        }

        if (mortgageDetailsEdit.getRateDisc().toString().equalsIgnoreCase("0")) {
            discountRateEditText.setText("");
        } else if (!mortgageDetailsEdit.getRateDisc().contains(".")) {
            discountRateEditText.setText(mortgageDetailsEdit.getRateDisc() + ".00");
        } else {
            discountRateEditText.setText(mortgageDetailsEdit.getRateDisc());
        }

        if (mortgageDetailsEdit.getTerm().equalsIgnoreCase("6")) {
            currentTermNumberTextView.setText(mortgageDetailsEdit.getTerm() + " Mth");
        } else {
            int term = Integer.parseInt(mortgageDetailsEdit.getTerm()) / 12;
            termsInMonth = String.valueOf(term);
            currentTermNumberTextView.setText(termsInMonth + " Yr");
        }
        mortgageTypeTextView.setText(mortgageDetailsEdit.getStatus());
        mortgageStatusTextView.setText(mortgageDetailsEdit.getType());
        actualStartDateEditText.setText(new PrimaryResidenceFragment().convertMilliSecondsToDate(mortgageDetailsEdit.getStartDate()));
        actualMaturityDateEditText.setText(new PrimaryResidenceFragment().convertMilliSecondsToDate(mortgageDetailsEdit.getMaturityDate()));
        if (!mortgageDetailsEdit.getCreditLineAmt().contains(".")) {
            creditLineAmtEditText.setText(mortgageDetailsEdit.getCreditLineAmt() + ".00");
        } else {
            creditLineAmtEditText.setText(mortgageDetailsEdit.getCreditLineAmt());
        }
        if (!mortgageDetailsEdit.getSavintAmtMonth().contains(".")) {
            savingAmtPerMonthEditText.setText(mortgageDetailsEdit.getSavintAmtMonth() + ".00");
        } else {
            savingAmtPerMonthEditText.setText(mortgageDetailsEdit.getSavintAmtMonth());
        }

        if (!mortgageDetailsEdit.getSavingAmtRemTerm().contains(".")) {
            actualremainingTermEditText.setText(mortgageDetailsEdit.getSavingAmtRemTerm() + ".00");
        } else {
            actualremainingTermEditText.setText(mortgageDetailsEdit.getSavingAmtRemTerm());
        }
        notifyMe = mortgageDetailsEdit.getNotifyMe();
        rateIncrease = mortgageDetailsEdit.getRateIncrease();
        actualRateIncreaseTextView.setText(mortgageDetailsEdit.getRateIncrease() + " bps");
        actualNotifyMeTextView.setText(mortgageDetailsEdit.getNotifyMe() + " Days Until Maturity");
        actualMpacEditText.setText(mortgageDetailsEdit.getMpacNumber());
    }

    public void stepOneDetails() {
        stepOneLinearLayout.setVisibility(View.VISIBLE);
        stepTwoLinearLayout.setVisibility(View.GONE);
        stepThreeLinearLayout.setVisibility(View.GONE);
        stepOneTextView.setBackgroundResource(R.drawable.steponesel);
        stepTwoTextView.setBackgroundResource(R.drawable.steptwounselectedstepthreeunselected);
        stepThreeTextView.setBackgroundResource(R.drawable.stepthreeunselected);
    }

    public void stepTwoDetails() {
        stepOneLinearLayout.setVisibility(View.GONE);
        stepTwoLinearLayout.setVisibility(View.VISIBLE);
        stepThreeLinearLayout.setVisibility(View.GONE);
        stepOneTextView.setBackgroundResource(R.drawable.oneunselectedtwoselected);
        stepTwoTextView.setBackgroundResource(R.drawable.steptwoselected);
        stepThreeTextView.setBackgroundResource(R.drawable.stepthreeunselected);
    }

    public void stepThreeDetails() {
        stepOneLinearLayout.setVisibility(View.GONE);
        stepTwoLinearLayout.setVisibility(View.GONE);
        stepThreeLinearLayout.setVisibility(View.VISIBLE);
        stepOneTextView.setBackgroundResource(R.drawable.oneunselectedthreeselected);
        stepTwoTextView.setBackgroundResource(R.drawable.steptwounselectedstepthreeselected);
        stepThreeTextView.setBackgroundResource(R.drawable.stepthreeselected);
    }

    public void rateIncreaseSpinnerSelect() {
        rateIncreaseRelativeLayout.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                AlertDialog.Builder builder = new AlertDialog.Builder(EditMortgageActivity.this);
                builder.setTitle("Rate Increase");
                builder.setItems(rateIncreaseItems, new DialogInterface.OnClickListener() {
                    public void onClick(DialogInterface dialog, int item) {
                        // Do something with the selection
                        actualRateIncreaseTextView.setText(rateIncreaseItems[item]);
                        if (rateIncreaseItems[item].toString().equalsIgnoreCase("10 bps")) {
                            rateIncrease = "10";
                        }
                        if (rateIncreaseItems[item].toString().equalsIgnoreCase("15 bps")) {
                            rateIncrease = "15";
                        }
                        if (rateIncreaseItems[item].toString().equalsIgnoreCase("20 bps")) {
                            rateIncrease = "20";
                        }
                        if (rateIncreaseItems[item].toString().equalsIgnoreCase("25 bps")) {
                            rateIncrease = "25";
                        }
                    }
                });
                AlertDialog alert = builder.create();
                alert.show();
            }

        });
    }

    public void notifyMeSpinnerSelect() {
        notifyMeRelativeLayout.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                AlertDialog.Builder builder = new AlertDialog.Builder(EditMortgageActivity.this);
                builder.setTitle("Notify Me");
                builder.setItems(noifyMeItems, new DialogInterface.OnClickListener() {
                    public void onClick(DialogInterface dialog, int item) {
                        // Do something with the selection
                        actualNotifyMeTextView.setText(noifyMeItems[item]);
                        if (noifyMeItems[item].toString().equalsIgnoreCase("90 Days Until Maturity")) {
                            notifyMe = "90";
                        }
                        if (noifyMeItems[item].toString().equalsIgnoreCase("120 Days Until Maturity")) {
                            notifyMe = "120";
                        }
                        if (noifyMeItems[item].toString().equalsIgnoreCase("180 Days Until Maturity")) {
                            notifyMe = "180";
                        }

                    }
                });
                AlertDialog alert = builder.create();
                alert.show();
            }
        });
    }

    public void currencySpineerTextViewSelect() {
        selectCurrencyRelativeLayout.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                AlertDialog.Builder builder = new AlertDialog.Builder(EditMortgageActivity.this);
                builder.setTitle("Select Currency");
                builder.setItems(currencyItems, new DialogInterface.OnClickListener() {
                    public void onClick(DialogInterface dialog, int item) {
                        // Do something with the selection
                        actaulCurrencyTextview.setText(currencyItems[item]);
                    }
                });
                AlertDialog alert = builder.create();
                alert.show();
            }
        });
    }

    public void paymentFrequencySpinnerTextviewSelect() {
        selectFrequencyRelativeLayout.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                AlertDialog.Builder builder = new AlertDialog.Builder(EditMortgageActivity.this);
                builder.setTitle("Select Frequency");
                builder.setItems(paymentFrequencyItems, new DialogInterface.OnClickListener() {
                    public void onClick(DialogInterface dialog, int item) {
                        // Do something with the selection
                        paymentFrequencyTwoTextview.setText(paymentFrequencyItems[item]);
                    }
                });
                AlertDialog alert = builder.create();
                alert.show();
            }
        });
    }

    public void mortgageTypeDropdownClick() {
        mortgageTypeTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                AlertDialog.Builder builder = new AlertDialog.Builder(EditMortgageActivity.this);
                builder.setItems(MortgageTypeItems, new DialogInterface.OnClickListener() {
                    public void onClick(DialogInterface dialog, int item) {
                        // Do something with the selection
                        mortgageTypeTextView.setText(MortgageTypeItems[item]);
                    }
                });
                AlertDialog alert = builder.create();
                alert.show();
            }
        });
    }

    public void mortgageStatusDropdownClick() {
        mortgageStatusTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                AlertDialog.Builder builder = new AlertDialog.Builder(EditMortgageActivity.this);
                builder.setItems(MortgageStatus, new DialogInterface.OnClickListener() {
                    public void onClick(DialogInterface dialog, int item) {
                        // Do something with the selection
                        mortgageStatusTextView.setText(MortgageStatus[item]);
                    }
                });
                AlertDialog alert = builder.create();
                alert.show();
            }
        });
    }


    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        // Inflate the menu; this adds items to the action bar if it is present.
        getMenuInflater().inflate(R.menu.main, menu);
        menu.findItem(R.id.icon).setVisible(true);
        menu.findItem(R.id.icon).setEnabled(false);
        menu.findItem(R.id.closeButton).setVisible(false);
        return true;
    }

    public boolean validationStepOne() {
        boolean bln = true;
        if (actualTitleEditText.getText().toString().equals("") && postalCodeEditText.getText().toString().equals("")
                && totalMortgageEditText.getText().toString().equals("") && currentAmortizedMortgageValueEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.enter_information_in_all_fields, Toast.LENGTH_LONG);
            bln = false;
        } else if (actualTitleEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.please_enter_title, Toast.LENGTH_LONG);
            actualTitleEditText.requestFocus();
            bln = false;
        } else if (selectLenderTextview.getText().toString().equalsIgnoreCase("Select Lender") && selectLenderTextview.isShown()) {
            toastMessage.showToastMsg(R.string.please_select_lender, Toast.LENGTH_LONG);
            bln = false;
        } else if (postalCodeEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.please_enter_postal_code, Toast.LENGTH_LONG);
            postalCodeEditText.requestFocus();
            bln = false;
        } else if (totalMortgageEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.please_enter_total_mortgage, Toast.LENGTH_LONG);
            totalMortgageEditText.requestFocus();
            bln = false;
        }
        return bln;

    }

    public boolean validationStepTwo() {
        boolean bln = true;
        Date date = new Date();
        if (AmortizationTermEditText.getText().toString().equals("") && currentPaymentAmtEditText.getText().toString().equals("") && actualInterestRateEditText.getText().toString().equals("")
                && discountRateEditText.getText().toString().equals("") && creditLineAmtEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.enter_information_in_all_fields, Toast.LENGTH_LONG);
            bln = false;
        } else if (AmortizationTermEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.please_enter_amortization_term, Toast.LENGTH_LONG);
            AmortizationTermEditText.requestFocus();
            bln = false;
        } else if (paymentFrequencyTwoTextview.getText().toString().contains("Select Frequency")) {
            toastMessage.showToastMsg(R.string.please_select_frequency, Toast.LENGTH_LONG);
            bln = false;
        } else if (currentPaymentAmtEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.please_enter_current_payment_amt, Toast.LENGTH_LONG);
            currentPaymentAmtEditText.requestFocus();
            bln = false;
        } else if (actualInterestRateEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.please_enter_interest_rate, Toast.LENGTH_LONG);
            actualInterestRateEditText.requestFocus();
            bln = false;
        }/*else if (discountRateEditText.getText().toString().equals("")) {
            discountRateEditText.requestFocus();
            toastMessage.showToastMsg(R.string.please_enter_rate_discount, Toast.LENGTH_LONG);
            bln = false;
        }*/ else if (currentTermNumberTextView.getText().toString().contains("Select Term") && mortgageTypeTextView.getText().toString().contains("Select Type") &&
                mortgageStatusTextView.getText().toString().contains("Select Type")) {
            toastMessage.showToastMsg(R.string.please_select_current_term_mortgage_details, Toast.LENGTH_LONG);
            bln = false;
        } else if (currentTermNumberTextView.getText().toString().contains("Select Term")) {
            toastMessage.showToastMsg(R.string.please_select_current_term_mortgage_details, Toast.LENGTH_LONG);
            bln = false;
        } else if (mortgageTypeTextView.getText().toString().contains("Select Type")) {
            toastMessage.showToastMsg(R.string.please_select_current_term_mortgage_details, Toast.LENGTH_LONG);
            bln = false;
        } else if (mortgageStatusTextView.getText().toString().contains("Select Type")) {
            toastMessage.showToastMsg(R.string.please_select_current_term_mortgage_details, Toast.LENGTH_LONG);
            bln = false;
        } else if (actualStartDateEditText.getText().toString().contains("Select Date")) {
            toastMessage.showToastMsg(R.string.please_select_date, Toast.LENGTH_LONG);
            bln = false;
        } else if (nextYear != null && nextYear.before(date)) {
            toastMessage.showToastMsg(R.string.maturity_date_before, Toast.LENGTH_LONG);
            actualMaturityDateEditText.setText("");
            actualStartDateEditText.setText("Select Date");
            bln = false;
        }

        return bln;
    }

    public boolean valiadationStepThree() {
        boolean bln = true;
        if (savingAmtPerMonthEditText.getText().toString().equals("") && actualremainingTermEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.enter_information_in_all_fields, Toast.LENGTH_LONG);
            savingAmtPerMonthEditText.requestFocus();
            bln = false;
        } else if (savingAmtPerMonthEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.enter_saving_amt_per_month, Toast.LENGTH_LONG);
            savingAmtPerMonthEditText.requestFocus();
            bln = false;
        } else if (actualremainingTermEditText.getText().toString().equals("")) {
            toastMessage.showToastMsg(R.string.enter_saving_amt_over_remaining_term, Toast.LENGTH_LONG);
            actualremainingTermEditText.requestFocus();
            bln = false;
        }
        return bln;
    }

    public void setDateTimeField() {

        actualStartDateEditText.setOnClickListener(this);
        //   actualMaturityDateEditText.setOnClickListener(this);

        final Calendar newCalendar = Calendar.getInstance();
        final Date date = new Date();
        final long datenew = date.getTime();
        arivalYear = newCalendar.get(Calendar.YEAR);
        arivalMonth = newCalendar.get(Calendar.MONTH);
        arivalDay = newCalendar.get(Calendar.DAY_OF_MONTH);

        fromDatePickerDialog = new DatePickerDialog(this, new DatePickerDialog.OnDateSetListener() {
            public void onDateSet(DatePicker view, int yearOne, int monthOfYearOne, int dayOfMonthOne) {
                Calendar calendar = Calendar.getInstance();
                calendar.set(yearOne, monthOfYearOne, dayOfMonthOne);
                startTime = calendar.getTimeInMillis();
                if (CommonConstants.mDebug) {
                    Log.v(TAG, "" + startTime);
                }
                actualStartDateEditText.setText(dateFormatter.format(calendar.getTime()));

                if (termsInMonth.equalsIgnoreCase("6")) {
                    calendar.add(Calendar.MONTH, 6);
                } else {
                    calendar.add(Calendar.YEAR, termInYear); // to get previous year add -1
                }
                nextYear = calendar.getTime();
                actualMaturityDateEditText.setText(dateFormatter.format(nextYear));
                maturityTime = calendar.getTimeInMillis();
                if (CommonConstants.mDebug) {
                    Log.v(TAG, "" + maturityTime);
                }
            }

        }, newCalendar.get(Calendar.YEAR), newCalendar.get(Calendar.MONTH), newCalendar.get(Calendar.DAY_OF_MONTH));
        fromDatePickerDialog.getDatePicker().setMaxDate(datenew);
    }

    @Override
    public void onClick(View v) {
        if (v == actualStartDateEditText) {
            fromDatePickerDialog.show();
        } else if (v == actualMaturityDateEditText) {
            toDatePickerDialog.show();
        }
    }

    public void showLenderList() {
        if (lenderLogoImageview.isEnabled()) {
            selectLenderRelativeLayout.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View v) {
                    showPopUp(lenderString, EditMortgageActivity.this);
                }
            });
        }
        if (selectLenderTextview.isEnabled()) {
            selectLenderRelativeLayout.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View v) {
                    showPopUp(lenderString, EditMortgageActivity.this);
                }
            });
        }
    }

    public void getLenderList() {
        HashMap<String, Object> stringObjectHashMap = new HashMap<>();
        stringObjectHashMap.put("lang", "en");
        stringObjectHashMap.put("req_from", "android");

        ErisCollectionManager.getInstance().callMethod("getLenderList", new Object[]{stringObjectHashMap}, new ResultListener() {
            @Override
            public void onSuccess(String result) {
                if (CommonConstants.mDebug) Log.v(TAG, result);
                try {
                    lenderString = new ArrayList<Bitmap>();
                    JSONObject jsonObject = new JSONObject(result);
                    if (jsonObject.getString("status").equalsIgnoreCase("true")) {
                        JSONObject jsonObject1 = jsonObject.getJSONObject("data");
                        JSONArray jsonArray = jsonObject1.getJSONArray("result");
                        for (int i = 0; i < jsonArray.length(); i++) {
                            JSONObject jsonObject2 = jsonArray.getJSONObject(i);
                            if (!jsonObject2.getString("lender_logo").equalsIgnoreCase("other")) {
                                ObjectItem objectItem = new ObjectItem();
                                objectItem.setLenderId(jsonObject2.getString("lender_id"));
                                objectItem.setLenderName(jsonObject2.getString("lender_name"));
                                String lenderStr = jsonObject2.getString("lender_logo");
                                String[] arrayString = lenderStr.split("\\,");
                                if (arrayString.length > 0) {
                                    lenderStr = arrayString[1];
                                }
                                lenderString.add(base64(lenderStr));
                                objectItem.setBase46String(lenderStr);
                                objectItemArrayList.add(objectItem);
                                ViewDialog.hideProgress();


                            }
                        }
                    }

                } catch (JSONException e) {
                    e.printStackTrace();
                }
            }

            @Override
            public void onError(String error, String reason, String details) {
                if (CommonConstants.mDebug) {
                    Log.v(TAG, reason);
                }
            }
        });
    }

    public Bitmap base64(String base64String) {

        byte[] decodedString = Base64.decode(base64String, Base64.DEFAULT);
        return BitmapFactory.decodeByteArray(decodedString, 0, decodedString.length);
    }


    public void showPopUp(List<Bitmap> list, final Activity activity) {
        final AlertDialog.Builder alertDialogBuilder = new AlertDialog.Builder(EditMortgageActivity.this);
        LayoutInflater inflater = ((Activity) activity).getLayoutInflater();
        final View myDialog = inflater.inflate(R.layout.lender_list, null);
        alertDialogBuilder.setView(myDialog);
        final ArrayAdapterItem adapter = new ArrayAdapterItem(activity, R.layout.list_view_row_item, list, objectItemArrayList);
        final ListView listView = (ListView) myDialog.findViewById(R.id.lenderListView);
        TextView closeButtonTextView = (TextView) myDialog.findViewById(R.id.closeButtonTextView);
        TextView otherTextView = (TextView) myDialog.findViewById(R.id.otherTextView);

        listView.setAdapter(adapter);
        final AlertDialog alertDialogShow = alertDialogBuilder.create();
        alertDialogShow.show();
        closeButtonTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                alertDialogShow.dismiss();
            }
        });

        otherTextView.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                if (CommonConstants.mDebug) {
                    Log.v(TAG, "on click other");
                }
                alertDialogShow.dismiss();
                showOtherLenderPopup(activity, "Other Lender");
            }
        });
        listView.setOnItemClickListener(new AdapterView.OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
                selectLenderTextview.setVisibility(View.GONE);
                lenderLogoImageview.setVisibility(View.VISIBLE);
                ObjectItem listItem = (ObjectItem) parent.getAdapter().getItem(position);
                lenderId = listItem.getLenderId();
                lenderName = listItem.getLenderName();
                if (CommonConstants.mDebug) {
                    Log.v(TAG, lenderId);
                    Log.v(TAG, lenderName);
                }
                lenderLogoImageview.setImageBitmap(listItem.getImageBitmap());
                alertDialogShow.dismiss();
            }
        });
    }


    public void showOtherLenderPopup(Activity activity, String title) {
        try {
            final AlertDialog.Builder alertDialogBuilder = new AlertDialog.Builder(EditMortgageActivity.this);
            LayoutInflater inflater = ((Activity) activity).getLayoutInflater();
            final View myDialog = inflater.inflate(R.layout.other_lender_popup, null);
            alertDialogBuilder.setView(myDialog);
            final AlertDialog alertDialog = alertDialogBuilder.create();
            alertDialog.show();
            TextView closeButtonTextView = (TextView) myDialog.findViewById(R.id.closeButton);
            Button btn_dialog = (Button) myDialog.findViewById(R.id.btn_dialog);
            TextView titleTextView = (TextView) myDialog.findViewById(R.id.titleTextView);
            titleTextView.setText(title);
            otherLenderErrorTextView = (TextView) myDialog.findViewById(R.id.otherLenderErrorTextView);
            lenderEditText = (EditText) myDialog.findViewById(R.id.lenderEditText);
            lenderEditText.setText(lenderNamePopup);


            btn_dialog.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View v) {
                    otherLenderName = lenderEditText.getText().toString();
                    if (otherLenderName.isEmpty()) {
                        otherLenderErrorTextView.setVisibility(View.VISIBLE);
                        otherLenderErrorTextView.setText("Please enter name of lender.");
                    } else {
                        lenderLogoImageview.setVisibility(View.GONE);
                        selectLenderTextview.setVisibility(View.VISIBLE);
                        selectLenderTextview.setText("Other");
                        lenderId = "";
                        if (CommonConstants.mDebug) {
                            Log.v(TAG, otherLenderName);
                        }
                        alertDialog.dismiss();
                    }
                }
            });
            closeButtonTextView.setOnClickListener(new View.OnClickListener() {
                @Override
                public void onClick(View v) {
                    alertDialog.dismiss();
                }
            });
        } catch (Exception e) {
            e.printStackTrace();
        }
    }


    public void updateMortgage(Activity activity) {
        HashMap<String, Object> stringObjectHashMap = new HashMap<>();
        if (lenderId == "") {
            stringObjectHashMap.put("lender_id", "1000");
            stringObjectHashMap.put("other_lender", otherLenderName);
        } else {
            stringObjectHashMap.put("lender_id", lenderId);
            stringObjectHashMap.put("other_lender", "");
        }
        stringObjectHashMap.put("_id", mortgageID);
        stringObjectHashMap.put("other_lender", "");
        stringObjectHashMap.put("title", actualTitleEditText.getText().toString());
        stringObjectHashMap.put("type", mortgageType);
        stringObjectHashMap.put("currency", actaulCurrencyTextview.getText().toString());
        stringObjectHashMap.put("property_postal_code", postalCodeEditText.getText().toString());
        stringObjectHashMap.put("original_amount", totalMortgageEditText.getText().toString().replace(",", ""));
        stringObjectHashMap.put("amortized_amount", currentAmortizedMortgageValueEditText.getText().toString().replace(",", ""));
        stringObjectHashMap.put("amortization_term_in_months", AmortizationTermEditText.getText().toString());
        stringObjectHashMap.put("current_payment_amount", currentPaymentAmtEditText.getText().toString().replace(",", ""));
        stringObjectHashMap.put("current_payment_frequency", paymentFrequencyTwoTextview.getText().toString());
        stringObjectHashMap.put("interest_rate_percentage", actualInterestRateEditText.getText().toString());
        if (discountRateEditText.getText().toString().equalsIgnoreCase("")) {
            stringObjectHashMap.put("discount_rate_percentage", "0.00");
        } else {
            stringObjectHashMap.put("discount_rate_percentage", discountRateEditText.getText().toString());
        }
        if (startTime == 0) {
            stringObjectHashMap.put("start_date_utc", startDateNotUpdated);
        } else {
            stringObjectHashMap.put("start_date_utc", startTime);
        }

        if (maturityTime == 0) {
            stringObjectHashMap.put("maturity_date_utc", maturityDateNotUpdated);
        } else {
            stringObjectHashMap.put("maturity_date_utc", maturityTime);
        }
//        int termInMonths=Integer.parseInt(termsInMonth)*12;
//        termInMonths=termInMonths/12;
        if (currentTermNumberTextView.getText().toString().equalsIgnoreCase("6 Mth")) {
            stringObjectHashMap.put("current_term_in_months", "6");
        } else {
            termInYear = termInYear * 12;
            stringObjectHashMap.put("current_term_in_months", termInYear);
        }
        stringObjectHashMap.put("current_term_type", mortgageTypeTextView.getText().toString());
        stringObjectHashMap.put("current_term_rate_type", mortgageStatusTextView.getText().toString());
        stringObjectHashMap.put("credit_line_amount", creditLineAmtEditText.getText().toString().replace(",", ""));
        stringObjectHashMap.put("notify_saving_amount_per_month", savingAmtPerMonthEditText.getText().toString().replace(",", ""));
        stringObjectHashMap.put("notify_saving_amount_over_remaining_term", actualremainingTermEditText.getText().toString().replace(",", ""));
        stringObjectHashMap.put("notify_rate_increase_bps", rateIncrease);
        stringObjectHashMap.put("notify_until_maturity_days", notifyMe);
        stringObjectHashMap.put("mpac_number", actualMpacEditText.getText().toString());
//        stringObjectHashMap.put("attached_documents", "");

        HashMap<String, Object> hashMap = new HashMap<>();
        if (facebookUserLoginFlag) {
            hashMap.put("user_id", facebookUserLoginId);
        } else if (googleUserLoginFlag) {
            hashMap.put("user_id", googleUserLoginId);
        } else {
            hashMap.put("user_id", username);
        }
        hashMap.put("lang", "en");
        hashMap.put("req_from", "android");
        if (!is_attachment_updated) {
            hashMap.put("is_attachment_updated", "N");
        } else {
            hashMap.put("is_attachment_updated", "Y");
        }
        hashMap.put("mortgage_input", stringObjectHashMap);

        ErisCollectionManager.getInstance().callMethod("updateMortgage", new Object[]{hashMap}, new ResultListener() {
            @Override
            public void onSuccess(String result) {
                if (CommonConstants.mDebug) Log.v(TAG, result);
                if (fileDataList.size() <= 0) {
                    if (CommonConstants.mDebug) Log.v(TAG, "No Attachment");
                    ViewDialog.hideProgress();

                    finish();
                } else if (!is_attachment_updated) {
                    if (CommonConstants.mDebug) Log.v(TAG, "Attachment not updated");
                    finish();
                    ViewDialog.hideProgress();
                } else {
                    try {
                        JSONObject jsonObjectMain = new JSONObject(result);
                        JSONObject jsonObjectData = jsonObjectMain.getJSONObject("data");
                        JSONObject jsonObjectResult = jsonObjectData.getJSONObject("result");
                        for (int i = 0; i < fileDataList.size(); i++) {
                            showProgress(R.string.help_screen_one, EditMortgageActivity.this, "Uploading " + i + " of " + fileDataList.size());
                            attachDocuments(jsonObjectResult.getString("mortgage_id"), i);
                        }
                    } catch (JSONException e) {
                        e.printStackTrace();
                    }
                    ViewDialog.hideProgress();
                }
            }

            @Override
            public void onError(String error, String reason, String details) {
                ViewDialog.showAlertPopUp(EditMortgageActivity.this, reason, "Error");
            }
        });
    }

    public static void showProgress(int title, Activity activity, String message) {
        KProgressHUD kProgressHUD = new KProgressHUD(activity);
        KProgressHUD.create(activity);
        kProgressHUD.setCancellable(false);
        kProgressHUD.setLabel(message);
        kProgressHUD.setAnimationSpeed(2);
        kProgressHUD.setDimAmount(0.5f);
        kProgressHUD.setStyle(KProgressHUD.Style.SPIN_INDETERMINATE);
        kProgressHUD.show();
    }

    public void attachDocuments(final String mortgageID, int counter) {
        if (CommonConstants.mDebug) Log.v(TAG, mortgageID);
        HashMap<String, Object> stringObjectHashMap = new HashMap<>();
        stringObjectHashMap.put("mortgage_id", mortgageID);
        if (is_document_deleted && is_attachment_updated) {
            String tmp = fileDataList.get(counter).getDocId();
            if (fileDataList.get(counter).getDocId() != null) {
                stringObjectHashMap.put("thumbnail_data", "");
                stringObjectHashMap.put("large_data", "");
                if (CommonConstants.mDebug)
                    Log.v(TAG, fileDataList.get(counter).getDocId());
                stringObjectHashMap.put("doc_id", fileDataList.get(counter).getDocId());
            } else {
                stringObjectHashMap.put("thumbnail_data", fileDataList.get(counter).getThumbNailBase64StringWithType());
                stringObjectHashMap.put("large_data", fileDataList.get(counter).getFileBase64StringWithType());
                stringObjectHashMap.put("doc_id", "");
            }
        } else {
            if (fileDataList.get(counter).getFileBase64StringWithType().contains("null")) {
                stringObjectHashMap.put("thumbnail_data", "");
                stringObjectHashMap.put("large_data", "");
                stringObjectHashMap.put("doc_id", fileDataList.get(counter).getDocId());
            } else {
                stringObjectHashMap.put("thumbnail_data", fileDataList.get(counter).getThumbNailBase64StringWithType());
                stringObjectHashMap.put("large_data", fileDataList.get(counter).getFileBase64StringWithType());
                stringObjectHashMap.put("doc_id", "");
            }
        }
        stringObjectHashMap.put("lang", "en");
        //     stringObjectHashMap.put("doc_number", counter + 1);
        //     Log.v("TAG", "counter " + counter);
        stringObjectHashMap.put("req_from", "android");
        ErisCollectionManager.getInstance().callMethod("saveMortgageAttachment", new Object[]{stringObjectHashMap}, new ResultListener() {
            @Override
            public void onSuccess(String result) {
                if (CommonConstants.mDebug) Log.v(TAG, result);
//                Intent intent = new Intent(EditMortgageActivity.this, MainActivity.class);
//                intent.putExtra("mortgageID", mortgageID);
//                startActivityForResult(intent, 1888);
                finish();
            }

            @Override
            public void onError(String error, String reason, String details) {
                if (CommonConstants.mDebug) Log.v(TAG, reason);
            }
        });
    }

    public static String getFileNameByUri(Context context, Uri uri) {
        String fileName = "unknown";//default fileName
        Uri filePathUri = uri;
        if (uri.getScheme().toString().compareTo("content") == 0) {
            Cursor cursor = context.getContentResolver().query(uri, null, null, null, null);
            if (cursor.moveToFirst()) {
                int column_index = cursor.getColumnIndexOrThrow(MediaStore.Images.Media.DATA);//Instead of "MediaStore.Images.Media.DATA" can be used "_data"
                filePathUri = Uri.parse(cursor.getString(column_index));
                fileName = filePathUri.getLastPathSegment().toString();
            }
        } else if (uri.getScheme().compareTo("file") == 0) {
            fileName = filePathUri.getLastPathSegment().toString();
        } else {
            fileName = fileName + "_" + filePathUri.getLastPathSegment();
        }
        return fileName;
    }

    public static String getMimeType(String url) {
        String type = null;
        String extension = MimeTypeMap.getFileExtensionFromUrl(url);
        if (extension != null) {
            MimeTypeMap mime = MimeTypeMap.getSingleton();
            type = mime.getMimeTypeFromExtension(extension.toLowerCase());
            if (type == null) {
                type = extension;
            }
        }
        return type;
    }

    public Bitmap roatedBitmap(String filePath, Bitmap bitmap) {
        ExifInterface exif = null;
        try {
            exif = new ExifInterface(filePath);
        } catch (IOException e1) {
            // TODO Auto-generated catch block
            e1.printStackTrace();
        }
        int orientation = exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, ExifInterface.ORIENTATION_NORMAL);
        Matrix matrix = new Matrix();

        switch (orientation) {
            case ExifInterface.ORIENTATION_NORMAL:
                return bitmap;
            case ExifInterface.ORIENTATION_FLIP_HORIZONTAL:
                matrix.setScale(-1, 1);
                break;
            case ExifInterface.ORIENTATION_ROTATE_180:
                matrix.postRotate(180);
                break;
            case ExifInterface.ORIENTATION_FLIP_VERTICAL:
                matrix.setRotate(180);
                matrix.postScale(-1, 1);
                break;
            case ExifInterface.ORIENTATION_TRANSPOSE:
                matrix.setRotate(90);
                matrix.postScale(-1, 1);
                break;
            case ExifInterface.ORIENTATION_ROTATE_90:
                matrix.postRotate(90);
                break;
            case ExifInterface.ORIENTATION_TRANSVERSE:
                matrix.setRotate(-90);
                matrix.postScale(-1, 1);
                break;
            case ExifInterface.ORIENTATION_ROTATE_270:
                matrix.postRotate(-90);
                break;
            default:
                return bitmap;
        }
        try {
            Bitmap bmRotated = Bitmap.createBitmap(bitmap, 0, 0, bitmap.getWidth(), bitmap.getHeight(), matrix, true);
            return bmRotated;
        } catch (OutOfMemoryError e) {
            e.printStackTrace();
            return null;
        }
    }
}
